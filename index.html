<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Version 5.0 Final Polish</title>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333333;
            --accent-color: #4a90e2;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --box-info-color: #b7950b; /* Gold/Dunkelgelb für Box-Info */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        h1 {
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        /* Statistik Container */
        .stats-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stat-box {
            background: var(--card-bg);
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 0.9em;
            font-weight: bold;
        }

        /* Hauptkarte */
        .card-container {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }

        .question {
            font-size: 1.4em;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* Die Frage bleibt stehen, wir brauchen aber Platz für die Antwort */
        .answer-section {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

        input[type="text"] {
            width: 80%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 15px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }

        button:hover {
            background-color: #357abd;
        }

        button:active {
            transform: scale(0.98);
        }

        /* Feedback Bereich */
        #feedback {
            margin-top: 15px;
            font-weight: bold;
            min-height: 24px;
        }

        .correct { color: var(--success-color); }
        .wrong { color: var(--error-color); }

        /* Goldene Box-Info */
        .box-transition-info {
            display: block;
            margin-top: 10px;
            font-size: 0.85em;
            color: var(--box-info-color);
            font-style: italic;
        }

        /* Korrektur Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .overlay-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .overlay-content h3 {
            margin-top: 0;
            color: var(--error-color);
        }

        .correction-text {
            margin: 15px 0;
            line-height: 1.5;
            color: #555;
        }

        .original-q-in-overlay {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
            color: #333;
        }

        .btn-override {
            background-color: var(--success-color);
            margin-right: 10px;
        }
        
        .btn-next {
            background-color: var(--accent-color);
        }

        /* Setup Bereich */
        #setup-container {
            text-align: center;
            margin-top: 50px;
        }
        
        textarea {
            width: 100%;
            max-width: 600px;
            height: 150px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <h1>Version 5.0 Final Polish</h1>

    <div id="setup-container">
        <p>Füge deine Vokabeln/Fragen hier ein (Format: Frage;Antwort | Frage;Antwort):</p>
        <textarea id="input-data" placeholder="Hund;Dog | Katze;Cat | ...">Hallo;Hello | Welt;World | Apfel;Apple | Wasser;Water | Haus;House</textarea>
        <br>
        <button onclick="startLearning()">Lernen starten</button>
    </div>

    <div id="learning-container" style="display:none; width: 100%; display: flex; flex-direction: column; align-items: center;">
        
        <div class="stats-container" id="stats-display">
            </div>

        <div class="card-container">
            <div id="question-text" class="question"></div>
            
            <div class="answer-section">
                <input type="text" id="user-answer" placeholder="Deine Antwort..." onkeypress="handleKeyPress(event)">
                <br>
                <button id="check-btn" onclick="checkAnswer()">Überprüfen</button>
                <div id="feedback"></div>
                <div id="box-transition" class="box-transition-info"></div>
            </div>
        </div>
    </div>

    <div id="correction-overlay" class="overlay">
        <div class="overlay-content">
            <h3>Nicht ganz...</h3>
            <span id="overlay-question" class="original-q-in-overlay"></span>
            <div class="correction-text" id="correction-details"></div>
            <div id="overlay-box-transition" class="box-transition-info" style="margin-bottom: 15px;"></div>
            
            <button class="btn-override" onclick="overrideCorrect()">Doch, das war richtig!</button>
            <button class="btn-next" onclick="nextCard()">Weiter</button>
        </div>
    </div>

    <script>
        // Datenstruktur
        let cards = [];
        let currentCardIndex = -1;
        
        // Leitner System Boxen: 0 bis 5 (insgesamt 6 Stufen)
        // 0 = Neu/Falsch, 5 = Meister
        // Wir erstellen dynamisch Arrays für Box 0-5
        let boxes = {
            0: [], 1: [], 2: [], 3: [], 4: [], 5: []
        };

        function startLearning() {
            const input = document.getElementById('input-data').value;
            if (!input.trim()) return alert("Bitte Daten eingeben!");

            const pairs = input.split('|');
            cards = [];
            
            // Reset Boxen
            boxes = { 0: [], 1: [], 2: [], 3: [], 4: [], 5: [] };

            pairs.forEach((pair, index) => {
                const [q, a] = pair.split(';');
                if (q && a) {
                    let newCard = {
                        id: index,
                        question: q.trim(),
                        answer: a.trim(),
                        box: 0, // Startet in Box 0
                        nextReview: Date.now() // Sofort fällig
                    };
                    cards.push(newCard);
                    boxes[0].push(newCard);
                }
            });

            if (cards.length === 0) return;

            document.getElementById('setup-container').style.display = 'none';
            document.getElementById('learning-container').style.display = 'flex'; // Flex für Zentrierung
            updateStats();
            loadNextCard();
        }

        function updateStats() {
            const container = document.getElementById('stats-display');
            container.innerHTML = '';
            
            // Zeige alle Boxen 0 bis 5 an
            for (let i = 0; i <= 5; i++) {
                let div = document.createElement('div');
                div.className = 'stat-box';
                div.innerText = `Box ${i}: ${boxes[i].length}`;
                container.appendChild(div);
            }
        }

        function loadNextCard() {
            // Logik: Suche Karte aus der niedrigsten Box, die fällig ist.
            // Vereinfachung hier: Wir nehmen zufällig eine aus der niedrigsten nicht-leeren Box (außer Box 5, die ist "fertig" oder wird selten wiederholt).
            
            let foundCard = null;
            
            // Priorisiere niedrige Boxen (0 bis 4)
            for (let i = 0; i < 5; i++) {
                if (boxes[i].length > 0) {
                    // Wähle eine zufällige Karte aus dieser Box
                    const randomIndex = Math.floor(Math.random() * boxes[i].length);
                    foundCard = boxes[i][randomIndex];
                    break;
                }
            }

            // Wenn alle Karten in Box 5 sind
            if (!foundCard && boxes[5].length > 0) {
                 document.getElementById('question-text').innerText = "Glückwunsch! Alle Karten sind in Box 5.";
                 document.getElementById('user-answer').style.display = 'none';
                 document.getElementById('check-btn').style.display = 'none';
                 return;
            }

            if (foundCard) {
                currentCardIndex = cards.findIndex(c => c.id === foundCard.id);
                
                // UI Reset
                document.getElementById('question-text').innerText = cards[currentCardIndex].question;
                document.getElementById('user-answer').value = '';
                document.getElementById('user-answer').focus();
                document.getElementById('feedback').innerText = '';
                document.getElementById('box-transition').innerText = ''; 
                document.getElementById('overlay-box-transition').innerText = '';
            }
        }

        // Hilfsfunktion: Text normalisieren (Satzzeichen entfernen, Kleinschreibung)
        function normalizeText(text) {
            return text
                .toLowerCase()
                .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()?]/g, "") // Entfernt Satzzeichen
                .replace(/\s{2,}/g, " ") // Doppelte Leerzeichen entfernen
                .trim();
        }

        function checkAnswer() {
            const userInp = document.getElementById('user-answer').value;
            const originalAnswer = cards[currentCardIndex].answer;
            
            // Vergleich mit der normalisierten Funktion (Toleranz für Satzzeichen)
            const isCorrect = normalizeText(userInp) === normalizeText(originalAnswer);

            if (isCorrect) {
                processResult(true);
            } else {
                showCorrectionOverlay(userInp, originalAnswer);
            }
        }

        function processResult(isCorrect) {
            const card = cards[currentCardIndex];
            const oldBox = card.box;
            let newBox = oldBox;

            // Box Logik
            if (isCorrect) {
                if (oldBox < 5) newBox++;
            } else {
                newBox = 0; // Bei Fehler zurück zu Box 0
            }

            // UI Feedback
            const feedbackEl = document.getElementById('feedback');
            const transitionText = `Box ${oldBox} ➔ Box ${newBox}`;

            if (isCorrect) {
                feedbackEl.innerHTML = '<span class="correct">Richtig!</span>';
                document.getElementById('box-transition').innerText = transitionText;
                
                // Daten aktualisieren
                moveCard(card, oldBox, newBox);
                
                // Kurz warten dann nächste Karte
                setTimeout(nextCard, 1500);
            } else {
                // Nur für den Fall, dass wir das Overlay umgehen oder für interne Logik
                moveCard(card, oldBox, newBox);
                return transitionText; // Rückgabe für Overlay
            }
        }

        function moveCard(card, oldBox, newBox) {
            // Aus alter Box entfernen
            boxes[oldBox] = boxes[oldBox].filter(c => c.id !== card.id);
            // Karte updaten
            card.box = newBox;
            // In neue Box schieben
            boxes[newBox].push(card);
            updateStats();
        }

        function showCorrectionOverlay(userAns, correctAns) {
            const card = cards[currentCardIndex];
            // Wir berechnen vorläufig, was passiert (Box Reset auf 0)
            const transitionText = `Box ${card.box} ➔ Box 0`;

            document.getElementById('overlay-question').innerText = "Frage: " + card.question;
            document.getElementById('correction-details').innerHTML = `
                Du hast geschrieben: <b>${userAns}</b><br>
                Richtig wäre: <b>${correctAns}</b>
            `;
            document.getElementById('overlay-box-transition').innerText = transitionText;
            
            document.getElementById('correction-overlay').style.display = 'flex';
        }

        function overrideCorrect() {
            // Benutzer sagt, es war doch richtig -> Wir werten es als richtig
            // Wir müssen die Karte NICHT auf 0 setzen, sondern eins hochstufen.
            // Da wir 'moveCard' noch nicht ausgeführt haben, können wir einfach processResult(true) simulieren
            // Aber Achtung: Das Overlay ist offen. 
            
            document.getElementById('correction-overlay').style.display = 'none';
            
            // Manuelles "Richtig" auslösen
            const card = cards[currentCardIndex];
            const oldBox = card.box;
            let newBox = oldBox < 5 ? oldBox + 1 : 5;
            
            // Direktes Feedback im Hauptfenster anzeigen für den Übergang
            const feedbackEl = document.getElementById('feedback');
            feedbackEl.innerHTML = '<span class="correct">Als richtig markiert!</span>';
            document.getElementById('box-transition').innerText = `Box ${oldBox} ➔ Box ${newBox}`;

            moveCard(card, oldBox, newBox);
            setTimeout(nextCard, 1500);
        }

        function nextCard() {
            // Wenn das Overlay offen war wegen "Falsch" und wir auf "Weiter" klicken:
            const overlay = document.getElementById('correction-overlay');
            if (overlay.style.display === 'flex') {
                // Es war falsch, also führen wir die Bestrafung (Box 0) durch
                const card = cards[currentCardIndex];
                moveCard(card, card.box, 0);
                overlay.style.display = 'none';
            }

            document.getElementById('user-answer').value = '';
            document.getElementById('feedback').innerText = '';
            document.getElementById('box-transition').innerText = '';
            loadNextCard();
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                checkAnswer();
            }
        }
    </script>
</body>
</html>
